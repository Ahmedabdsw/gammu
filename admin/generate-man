#!/usr/bin/env python
# -*- coding: UTF-8 -*-
# vim: expandtab sw=4 ts=4 sts=4:
'''
Gammu man page generator
'''
__author__ = 'Michal Čihař'
__email__ = 'michal@cihar.com'
__license__ = '''
Copyright (c) 2003 - 2007 Michal Čihař

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License version 2 as published by
the Free Software Foundation.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along with
this program; if not, write to the Free Software Foundation, Inc.,
51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
'''

# Configuration

'''
Path to gammu binary.
'''
BIN_PATH = 'build/gammu/gammu'

'''
Output path where man page will be stored.
'''
OUT_PATH = '/tmp/gammu.1'


# Man page data

HEADER = '.TH "Gammu" "1" "%(date)s (%(version)s)" "Gammu team" "Cellular phones utilities"\n'
CHAPTER_HEADER = '\n.SH "%s"\n'
PARAGRAPH = '.TP\n%s\n'

# Code

import os
import re

SECTION_MATCHER = re.compile(' (.*) - (.*)')
COMMAND_MATCHER = re.compile('--(([^ ]*)( (.*))?)')

def read_help(section):
    pipe = os.popen('%s --help %s' % (BIN_PATH, section))
    data = pipe.readlines()
    pipe.close()
    return data

def parse_sections(lines):
    sections = []
    section_data = {}
    for line in lines:
        match = SECTION_MATCHER.match(line)
        if match is None:
            continue
        section = match.groups(1)[0]
        sections.append(section)
        section_data[section] = match.groups(1)[1]
    return sections, section_data

def parse_man_page(lines):
    result = {}
    for line in lines:
        match = COMMAND_MATCHER.match(line)
        command = match.groups(1)[1]
        options = match.groups(1)[3]
        result[command] = options
    return result

def format_man_page(output, data):
    keys = data.keys()
    keys.sort()
    for command in keys:
        output.write('.TP\n\\fB%(command)s\\fR\n' % {'command' : command})

def main():
    text = read_help('')
    result = re.match('\[Gammu version ([0-9.]*) built [0-9:]* (.*)\]', text[0])
    build_date = result.groups(1)[1]
    version = result.groups(1)[0]
    output = file(OUT_PATH, 'w')
    output.write(HEADER % {'version' : version, 'date' : build_date})

    output.write(CHAPTER_HEADER % 'OPTIONS')
    sections, section_data = parse_sections(text[12:])
    for section in sections:
        section_text = read_help(section)
        output.write(CHAPTER_HEADER % section_data[section])
        data = parse_man_page(section_text[4:])
        format_man_page(output, data)

    output.close()

if __name__ == '__main__':
    main()
