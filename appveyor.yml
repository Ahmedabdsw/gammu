version: "{build}"

image: Visual Studio 2015

configuration: Release

shallow_clone: true

environment:
  MYSQL_PATH: C:\Program Files\MySql\MySQL Server 5.7
  POSTGRESQL_PATH: C:\Program Files\PostgreSQL\9.5
  PGUSER: postgres
  PGPASSWORD: Password12!
  matrix:
    - GENERATOR: "Visual Studio 14 2015"
    - GENERATOR: "Visual Studio 14 2015 Win64"

clone_folder: c:\projects\gammu

install:
  - "SET PATH=c:\\projects\\gammu;%PATH%"

before_build:
  - appveyor DownloadFile https://download.microsoft.com/download/f/2/6/f263ac46-1fe9-4ae9-8fd3-21102100ebf5/msxsl.exe
  - cmd: >-
         "%MYSQL_PATH%\\bin\\mysql.exe" "--password=Password12!" "--user=root" "-e" "create database smsd;"
  - cmd: >-
         "%POSTGRESQL_PATH%\\bin\\createdb.exe" smsd
  - cmake -G "%GENERATOR%" -DCMAKE_INSTALL_PREFIX=%P% "-DODBC_DSN=mysql:Driver={MySQL ODBC 5.3 Unicode Driver}:host=localhost;dbname=smsd" -DMYSQL_USER=root "-DMYSQL_PASSWORD=Password12!" -DPSQL_USER=postgres "-DPSQL_PASSWORD=Password12!" -DODBC_TESTING=ON -DMYSQL_TESTING=ON -DPSQL_TESTING=ON

build:
  project: ALL_BUILD.vcxproj
  parallel: true
  verbosity: minimal

after_build:
  - cmake --build .  --config Release --target package

test_script:
  - ps: >-
        try 
        {
            $ret = 0
            ctest --output-on-failure --no-compress-output --dashboard ExperimentalTest --build-config Release
        }
        catch 
        {
            $ret = 1
        }
        finally
        {
            Copy-Item Testing\$(Get-Content Testing\TAG -TotalCount 1)\Test.xml test.xml
            msxsl test.xml admin/ctest-to-junit.xsl -o junit.xml
            # upload results to AppVeyor
            $wc = New-Object 'System.Net.WebClient'
            $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\junit.xml))
        }
        return $ret

services:
  - mysql
  - postgresql

artifacts:
  - path: Gammu-*-Windows.exe
    name: Installer
  - path: CMakeFiles/CMakeOutput.log
    name: CMake log
  - path: CMakeFiles/CMakeError.log
    name: CMake errors

#on_finish:
#  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
